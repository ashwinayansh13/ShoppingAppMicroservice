# Azure Pipeline YAML for SimpleProject Microservices
# This pipeline builds and publishes Docker images to Docker Hub

trigger:
  branches:
    include:
      - none

variables:
  # Docker Hub configuration
  dockerHubUser: 'shoppingapp'
  containerRegistry: 'docker.io'

  # Image names (IMPORTANT FIX)
  galleryServiceImage: 'galleryservice'
  checkoutServiceImage: 'checkoutservice'
  webGatewayImage: 'webgateway'

  # Docker image tags (clean)
  galleryServiceTag: '$(Build.BuildId)'
  checkoutServiceTag: '$(Build.BuildId)'
  webGatewayTag: '$(Build.BuildId)'

  # Build configuration
  buildConfiguration: 'Release'

stages:
# ---------------- BUILD STAGE ----------------
- stage: Build
  displayName: 'Build and Test'
  jobs:
  - job: Build
    displayName: 'Build .NET Solution'
    pool:
      vmImage: ubuntu-latest

    steps:
    - task: UseDotNet@2
      displayName: 'Use .NET 8.0 SDK'
      inputs:
        packageType: 'sdk'
        version: '8.0.x'

    - task: DotNetCoreCLI@2
      displayName: 'Restore NuGet packages'
      inputs:
        command: 'restore'
        projects: '**/*.sln'

    - task: DotNetCoreCLI@2
      displayName: 'Build solution'
      inputs:
        command: 'build'
        projects: '**/*.sln'
        arguments: '--configuration $(buildConfiguration) --no-restore'

# ---------------- DOCKER BUILD STAGE ----------------
- stage: BuildDockerImages
  displayName: 'Build Docker Images'
  dependsOn: Build
  jobs:
  - job: BuildAllImages
    displayName: 'Build All Docker Images'
    pool:
      vmImage: ubuntu-latest

    steps:
    - script: |
        docker build \
          -f Services/GalleryService/Dockerfile \
          -t $(dockerHubUser)/$(galleryServiceImage):$(galleryServiceTag) \
          -t $(dockerHubUser)/$(galleryServiceImage):latest \
          .
      displayName: 'Build GalleryService Image'

    - script: |
        docker build \
          -f Services/CheckoutService/Dockerfile \
          -t $(dockerHubUser)/$(checkoutServiceImage):$(checkoutServiceTag) \
          -t $(dockerHubUser)/$(checkoutServiceImage):latest \
          .
      displayName: 'Build CheckoutService Image'

    - script: |
        docker build \
          -f Services/WebGateway/Dockerfile \
          -t $(dockerHubUser)/$(webGatewayImage):$(webGatewayTag) \
          -t $(dockerHubUser)/$(webGatewayImage):latest \
          .
      displayName: 'Build WebGateway Image'

# ---------------- PUSH STAGE ----------------
- stage: PushImages
  displayName: 'Push Docker Images to Docker Hub'
  dependsOn: BuildDockerImages
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  jobs:
  - job: PushAllImages
    displayName: 'Push Images to Docker Hub'
    pool:
      vmImage: ubuntu-latest

    steps:
    - task: Docker@2
      displayName: 'Login to Docker Hub'
      inputs:
        command: login
        containerRegistry: 'ShoppingAppDockerHub'

    - script: |
        docker push $(dockerHubUser)/$(galleryServiceImage):$(galleryServiceTag)
        docker push $(dockerHubUser)/$(galleryServiceImage):latest
      displayName: 'Push GalleryService Image'

    - script: |
        docker push $(dockerHubUser)/$(checkoutServiceImage):$(checkoutServiceTag)
        docker push $(dockerHubUser)/$(checkoutServiceImage):latest
      displayName: 'Push CheckoutService Image'

    - script: |
        docker push $(dockerHubUser)/$(webGatewayImage):$(webGatewayTag)
        docker push $(dockerHubUser)/$(webGatewayImage):latest
      displayName: 'Push WebGateway Image'
