# Azure Pipeline YAML for ShoppingApp Microservices
# Builds .NET solution and Docker images, then pushes to Docker Hub

trigger:
  branches:
    include:
      - main

variables:
  # Docker Hub configuration
  dockerHubUser: 'shoppingapp'

  # Build configuration
  buildConfiguration: 'Release'

stages:
# ======================================================
# STAGE 1: BUILD .NET SOLUTION
# ======================================================
- stage: Build
  displayName: 'Build .NET Solution'
  jobs:
  - job: Build
    displayName: 'Restore, Build, Test'
    pool:
      vmImage: ubuntu-latest

    steps:
    - task: UseDotNet@2
      displayName: 'Use .NET 8 SDK'
      inputs:
        packageType: 'sdk'
        version: '8.0.x'

    - task: DotNetCoreCLI@2
      displayName: 'Restore NuGet Packages'
      inputs:
        command: restore
        projects: '**/*.sln'

    - task: DotNetCoreCLI@2
      displayName: 'Build Solution'
      inputs:
        command: build
        projects: '**/*.sln'
        arguments: '--configuration $(buildConfiguration) --no-restore'

    - task: DotNetCoreCLI@2
      displayName: 'Run Tests'
      inputs:
        command: test
        projects: '**/*Tests/*.csproj'
        arguments: '--configuration $(buildConfiguration) --no-build'
      continueOnError: true

# ======================================================
# STAGE 2: BUILD + PUSH DOCKER IMAGES
# ======================================================
- stage: BuildAndPushDockerImages
  displayName: 'Build and Push Docker Images'
  dependsOn: Build
  condition: eq(variables['Build.SourceBranch'], 'refs/heads/main')

  jobs:
  - job: BuildAndPush
    displayName: 'Docker Build & Push'
    pool:
      vmImage: ubuntu-latest

    steps:
    # Login using Docker Hub service connection
    - task: Docker@2
      displayName: 'Login to Docker Hub'
      inputs:
        command: login
        containerRegistry: 'ShoppingAppDockerHub'

    # ------------------ GalleryService ------------------
    - script: |
        docker build \
          -f Services/GalleryService/Dockerfile \
          -t $(dockerHubUser)/galleryservice:$(Build.BuildId) \
          -t $(dockerHubUser)/galleryservice:latest \
          .
        docker push $(dockerHubUser)/galleryservice:$(Build.BuildId)
        docker push $(dockerHubUser)/galleryservice:latest
      displayName: 'Build & Push GalleryService'

    # ------------------ CheckoutService -----------------
    - script: |
        docker build \
          -f Services/CheckoutService/Dockerfile \
          -t $(dockerHubUser)/checkoutservice:$(Build.BuildId) \
          -t $(dockerHubUser)/checkoutservice:latest \
          .
        docker push $(dockerHubUser)/checkoutservice:$(Build.BuildId)
        docker push $(dockerHubUser)/checkoutservice:latest
      displayName: 'Build & Push CheckoutService'

    # ------------------ WebGateway ----------------------
    - script: |
        docker build \
          -f Services/WebGateway/Dockerfile \
          -t $(dockerHubUser)/webgateway:$(Build.BuildId) \
          -t $(dockerHubUser)/webgateway:latest \
          .
        docker push $(dockerHubUser)/webgateway:$(Build.BuildId)
        docker push $(dockerHubUser)/webgateway:latest
      displayName: 'Build & Push WebGateway'
